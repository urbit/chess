<!DOCTYPE html>
<html>
  <head>
    <title>Chess</title>
    <link rel="stylesheet" href="/~chess/chessboard-css.css">
    <script type="application/javascript" src="/~modulo/session.js"></script>
    <script type="application/javascript" src="/~/channel/channel.js"></script>
 
    <script src="https://code.jquery.com/jquery-1.12.4.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.2/chess.js"></script>
    <script src="~chess/chessboard-js.js"></script>
    <style type="text/css">
      .disabled { pointer-events: none; }
    </style>
  </head>
  <body>
    <div id="header" style="">
      <a href="/~chess">Back</a>
    </div>
    <div id="board" style="width: 400px"></div>
    <script>
      let path = window.location.pathname.split("/");
      let boardDiv = document.getElementById("board");
      let oShip = path[2];
      let gameId = path[3];
      let orientation = "";
      let didIMove = false;

      var game;
      var board;

      var onDragStart = function(source, piece, position, ori) {
        if (orientation === "white" && piece.search(/^b/) !== -1) {
          return false;
        } else if (orientation === "black" && piece.search(/^w/) !== -1) {
          return false;
        }

        if (game.in_checkmate() === true || game.in_draw() === true) {
          return false;
        }
      };

      var onDrop = function(source, target) {
        // see if the move is legal
        var move = game.move({
          from: source,
          to: target,
          promotion: "q" // NOTE: always promote to a queen for example simplicity
        });

        // illegal move
        if (move === null) return "snapback";
        didIMove = true;
      };

      // update the board position after the piece snap
      // for castling, en passant, pawn promotion
      var onSnapEnd = function() {
        board.position(game.fen());
      };

      function daToDate(st) {
        var dub = function(n) {
          return parseInt(n) < 10 ? "0" + parseInt(n) : n.toString();
        };
        var da = st.split('..');
        var bigEnd = da[0].split('.');
        var lilEnd = da[1].split('.');
        var ds = `${bigEnd[0].slice(1)}-${dub(bigEnd[1])}-${dub(bigEnd[2])}T${dub(lilEnd[0])}:${dub(lilEnd[1])}:${dub(lilEnd[2])}Z`;
        return new Date(ds);
      }

      function onChangeFunc(oldPos, newPos) {
        if (!didIMove) { return; }
        didIMove = false;
        let gid = Math.trunc(daToDate(gameId).getTime() / 1000);

        let fen = game.fen(); 
        window.urb.poke(window.ship, "chess", "chess-command", 
          {pos: { shp: oShip, gid: gid, pos: fen }},
          (json) => {
            if ((game.turn() === "b" && orientation === "black") ||
                 game.turn() === "w" && orientation === "white") {
              boardDiv.className = "";
            } else {
              boardDiv.className = "disabled";
            }
          },
          (err) => {
            console.log(err);
          }
        );
      }

      var cfg = {
        draggable: true,
        dropOffBoard: 'snapback', // this is the default
        position: 'start',
        onDragStart: onDragStart,
        onDrop: onDrop,
        onSnapEnd: onSnapEnd,
        onChange: onChangeFunc
      };
      board = ChessBoard('board', cfg);

      function doSubGame() {
        window.urb.subscribe(window.ship, "chess",
          "/game/~" + oShip + "/" + gameId,
          (err) => {
            console.log(err);
          },
          (event) => {
            console.log(event);

            //board = ChessBoard('board', cfg);
            board.position(event.fen);
            if (event.fen !== "") {
              game = new Chess(event.fen);
            } else {
              game = new Chess();
            }

            board.orientation(event.orientation);
            orientation = event.orientation;

            if ((game.turn() === "b" && orientation === "black") ||
                 game.turn() === "w" && orientation === "white") {
              boardDiv.className = "";
            } else {
              boardDiv.className = "disabled";
            }
          },
          () => {
            doSubGame();
          }
        );
      }
      doSubGame();
    </script>
  </body>
</html>
